digraph beagleg {
    node [fontsize=10, fontname="Helvetica"];
    edge [fontsize=10, fontname="Helvetica"];

    {
       node [ shape=oval ];
       TCP [label = "TCP socket"];
    }

    {
       node [ shape=box ];
       GCodeParser;
       GCodeMachineControl [ label = "GCodeMachineControl\nGCode Actions\nPath planning"];
       HardwareMapping;
       MotorOperations  [label = "MotorOperations\nConvert segments\ninto firmware commands"];
       DummyMotionQueue [label = "DummyMotionQueue\nfor dryrun.", style=dotted];
       PRUMotionQueue;
       SimFirmwareQueue [label = "SimFirmwareQueue\nSimulating PRU", style=dotted];
       PRU [ label = "PRU firmware\n(motor-interface-pru.p)" ];
    }      

    {
      CapeConfig [ label = "Cape config in\nhardware/"];
      UserMapConfig [ label = "User config file:\nMapping sections"];
      UserAxisConfig [ label = "User config file:\nAxis sections"];
      GNUPlotOutput [ style = dotted ];
      PinToggeling [ label = "Pin Toggling,\nPWM control." ];
    }

    File -> GCodeParser [ label="G-Code", style=dotted];
    TCP -> GCodeParser  [ label="G-Code"];

    {
      GCodeParser -> GCodeMachineControl [ label=" Parse Events;\l Metric coordinates.\l Logic axes (X, Y, Z..)"];
      GCodeMachineControl -> MotorOperations [ label = " LinearSegmentSteps\l Step coordinates.\l Logic axes assigned to motors 1, 2, 3..." ]
      MotorOperations -> PRUMotionQueue [ label = " MotionSegment\lPrepared for PRU"]
      MotorOperations -> SimFirmwareQueue -> GNUPlotOutput;
      MotorOperations -> DummyMotionQueue;

      PRUMotionQueue -> PRU [ label = "Host -> PRU\lringbuffer"];
    }

    {
      rank = same;
      GCodeMachineControl -> HardwareMapping [ label="Request Output\nPWM, Spindle, Fan...", rank=0];
      HardwareMapping -> GCodeMachineControl [ label = "Axis -> motor mapping."];
      HardwareMapping -> GCodeMachineControl [ label = "Switch status." ];
    }

    { 
      rank = same; 
      UserAxisConfig -> GCodeMachineControl;
    }

    CapeConfig -> HardwareMapping;
    UserMapConfig -> HardwareMapping;
    HardwareMapping -> PinToggeling;
}
